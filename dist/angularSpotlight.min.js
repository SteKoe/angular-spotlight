angular.module('de.stekoe.angular.spotlight', [])
    .directive('spotlightOverlay', function ($timeout, $http, $compile, AngularSpotlight) {
        const KEY_UP = 40;
        const KEY_DOWN = 38;
        const SPACE = 32;
        const KEY_ESC = 27;

        var $ngSpotlightElement,
            $ngSpotlightDetailPanel,
            $ngSpotlightResultsPanel;

        return {
            restrict: 'E',
            controller: function ($scope) {
                $scope.searchResultsCount = 0;
                $scope.searchResults = [];
                $scope.selectedItem = undefined;
                $scope.searchInputInfo = undefined;

                $scope.search = function () {
                    AngularSpotlight.search($scope.searchTerm)
                        .then(function setSearchResult(resp) {
                            growInputField();

                            $scope.selectedItem = undefined;
                            $scope.searchResults = resp;
                            $scope.searchResultsCount = Object.keys($scope.searchResults)
                                .map(function (key) {
                                    return $scope.searchResults[key].items.length;
                                })
                                .reduce(function (prev, cur) {
                                    return prev + cur;
                                }, 0);

                            $timeout(function() {
                                if(!$scope.selectedItem)  {
                                    selectItemAtIndex(0, false);
                                }
                            }, 20);
                        });
                };

                $scope.getIconForType = function (type) {
                    return AngularSpotlight.getIconForType(type);
                };

                $scope.showResultItem = function (event, b) {
                    var currentItem = $(event.currentTarget);
                    var categoryName = currentItem.closest('.ng-spotlight-results-category').find('.ng-spotlight-results-list-header').text();

                    currentItem.closest('.ng-spotlight-results-list')
                        .find('.ng-spotlight-results-list-item')
                        .removeClass('active');
                    currentItem.addClass('active');

                    $scope.selectedItem = b;
                    setSearchInputInfo(categoryName);
                };

                $scope.selectPreviousEntry = function () {
                    var idx = getSelectedItemIndex();
                    if (idx - 1 >= 0) {
                        selectItemAtIndex(idx - 1, true)
                    }
                };

                $scope.selectNextEntry = function () {
                    var idx = getSelectedItemIndex();
                    if (idx + 1 < $scope.searchResultsCount) {
                        selectItemAtIndex(idx + 1, true);
                    }
                };

                $scope.resetSearch = function() {
                    $ngSpotlightElement.find('.ng-spotlight-input').val('');
                    $scope.searchResultsCount = 0;
                    $scope.searchResults = [];
                    $scope.selectedItem = undefined;
                    $scope.searchInputInfo = undefined;
                    $scope.searchTerm = "";
                    $scope.$apply();

                    growInputField();
                };

                function growInputField() {
                    $ngSpotlightElement.find('.ng-spotlight-input').autoGrowInput();
                }

                function selectItemAtIndex(idx, performApply) {
                    var resultsList = $ngSpotlightElement.find('.ng-spotlight-results-list');
                    var resultItems = resultsList.find('li.ng-spotlight-results-list-item');
                    var newActiveItem = $(resultItems.get(idx));
                    var categoryName = newActiveItem.closest('.ng-spotlight-results-category').find('.ng-spotlight-results-list-header').text();

                    resultItems.removeClass('active');
                    newActiveItem.addClass('active');

                    $scope.selectedItem = getResultItemFromSearchResults(idx);
                    setSearchInputInfo(categoryName);

                    if(performApply) {
                        $scope.$apply();
                    }
                }

                function setSearchInputInfo(categoryName) {
                    $scope.searchInputInfo = undefined;
                    if($scope.searchTerm.length === 0) {
                        $scope.searchInputInfo = undefined;
                    } else if($scope.selectedItem) {
                        $scope.searchInputInfo = $scope.selectedItem.name + " - " + categoryName;
                    } else if(Object.keys($scope.searchResults).length === 0) {
                        $scope.searchInputInfo = "Keine Ergebnisse";
                    }
                }

                function getResultItemFromSearchResults(idx) {
                    var resultItems = Object.keys($scope.searchResults)
                        .map(function (key) {
                            return $scope.searchResults[key].items;
                        })
                        .reduce(function (prev, cur) {
                            return prev.concat(cur);
                        }, []);
                    return resultItems[idx];
                }

                function getSelectedItemIndex() {
                    var resultsList = $ngSpotlightElement.find('.ng-spotlight-results-list');
                    var resultItems = resultsList.find('li.ng-spotlight-results-list-item');
                    var activeIndex = -1;

                    resultItems.each(function (idx, elem) {
                        if ($(elem).hasClass('active')) {
                            activeIndex = idx;
                            return false;
                        }
                    });

                    return activeIndex;
                }
            },
            link: function ($scope, element) {
                var spotlightOverlay = $(element).children();
                $ngSpotlightElement = $(element);
                $ngSpotlightDetailPanel = $ngSpotlightElement.find('.ng-spotlight-results-detail');
                $ngSpotlightResultsPanel = $ngSpotlightElement.find('.ng-spotlight-results-panel');

                $(document).click(function (e) {
                    console.log();
                    if ($(e.target).closest('.ng-spotlight').length === 0) {
                        spotlightOverlay.hide();
                    }
                });

                $(document).keydown(function (e) {
                    if (e.ctrlKey && e.keyCode === SPACE) {
                        e.preventDefault();
                        spotlightOverlay.toggle();
                        if (spotlightOverlay.is(':visible')) {
                            spotlightOverlay.find('input')
                                .focus()
                                .val('');
                            $scope.searchResults = [];
                        }
                    }

                    if(e.keyCode === KEY_ESC) {
                        e.preventDefault();
                        $scope.resetSearch();
                    }

                    if (e.keyCode === KEY_DOWN) {
                        e.preventDefault();
                        $scope.selectPreviousEntry();
                    }

                    if (e.keyCode === KEY_UP) {
                        e.preventDefault();
                        $scope.selectNextEntry();
                    }
                });
            },
            templateUrl: 'angularSpotlightTemplate.html'
        };
    })
    .directive('spotlightResultIcon', function($compile, AngularSpotlight) {
        var iconTemplates = {
            'url': '<img class="ng-spotlight-item-icon" ng-src="{{iconDescriptor.data}}">',
            'css': '<div class="ng-spotlight-item-icon" ng-class="iconDescriptor.data"></div>'
        };

        return {
            restrict: "E",
            scope: {
                selectedItem : '='
            },
            link: function(scope, element, attrs) {
                if(attrs.type) {
                    updateResultIcon(AngularSpotlight.getIconDescriptorForType(attrs.type));
                } else  {
                    scope.$watch('selectedItem', function() {
                        if(scope.selectedItem) {
                            updateResultIcon(AngularSpotlight.getIconDescriptorForType(scope.selectedItem.type));
                        } else {
                            element.html("");
                        }
                    })
                }

                function updateResultIcon(iconDescriptor) {
                    var iconTemplate = iconTemplates[iconDescriptor.type];
                    element.html(iconTemplate).show();
                    $compile(element.contents())(scope);
                    scope.iconDescriptor = iconDescriptor;
                }
            }
        }
    })
    .directive('spotlightDetails', function ($compile, AngularSpotlight) {
        return {
            restrict: "E",
            link: function (scope, element) {
                scope.$watch('selectedItem', function () {
                    if (scope.selectedItem) {
                        element.html(AngularSpotlight.getTemplateForType(scope.selectedItem.type)).show();
                        $compile(element.contents())(scope);
                    }
                });
            }
        };
    })
    .provider("AngularSpotlight", function () {
        var _iconConfig = iconConfig();
        var _detailsTemplateConfig = detailsTemplateConfig();

        this.search = function () {
            throw "You have to implement a search function using AngularSpotlightProvider!";
        };

        this.addIcons = _iconConfig.addIcons;
        this.addTemplates = _detailsTemplateConfig.addTemplates;

        this.$get = function ($http) {
            var that = this;
            return {
                search: that.search($http),
                getIconDescriptorForType: _iconConfig.getIconForType,
                getTemplateForType: _detailsTemplateConfig.getTemplateForType
            };
        };

        function iconConfig() {
            var icons = {
                'default': 'fa fa-file'
            };

            function addIcons(iconDescriptors) {
                Object.keys(iconDescriptors)
                    .forEach(function(iconKey) {
                        icons[iconKey] = iconDescriptors[iconKey];
                    });
            }

            function getIconForType(type) {
                var icon = icons[type] || icons['default'];

                return {
                    data: icon,
                    type: guessType(icon)
                };

                function guessType(icon) {
                    var icon = icon.toLowerCase();
                    if(icon.indexOf('http') === 0 || icon.indexOf('data:') === 0) {
                        return 'url';
                    } else {
                        return 'css';
                    }
                }
            }

            return {
                addIcons: addIcons,
                getIconForType: getIconForType
            }
        }

        function detailsTemplateConfig() {
            var detailsTemplates = {
                'default' : '<div class="ng-spotlight-results-detail-default">{{selectedItem.name}}</div>'
            };

            function addTemplates(templateDescriptors) {
                Object.keys(templateDescriptors)
                    .forEach(function(templateKey) {
                        detailsTemplates[templateKey] = templateDescriptors[templateKey];
                    });
            }

            function getTemplateForType(type) {
                return detailsTemplates[type] || detailsTemplates['default'];
            }

            return {
                addTemplates: addTemplates,
                getTemplateForType: getTemplateForType
            }
        }
    });

angular.module('de.stekoe.angular.spotlight').run(['$templateCache', function($templateCache) {
    $templateCache.put('angularSpotlightTemplate.html',
        "<div class=\"ng-spotlight ng-spotlight-overlay\">\n    <div class=\"ng-spotlight-searchbar\">\n        <div class=\"ng-spotlight-icon\">\n            <svg version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" x=\"0px\" y=\"0px\"  viewBox=\"0 0 283.753 284.51\" enable-background=\"new 0 0 283.753 284.51\" xml:space=\"preserve\">\n            <path d=\"M281.394,264.378l0.135-0.135L176.24,158.954c30.127-38.643,27.45-94.566-8.09-130.104\n\tc-38.467-38.467-100.833-38.467-139.3,0c-38.467,38.467-38.466,100.833,0,139.299c35.279,35.279,90.644,38.179,129.254,8.748\n\tl103.859,103.859c0.01,0.01,0.021,0.021,0.03,0.03l1.495,1.495l0.134-0.134c2.083,1.481,4.624,2.36,7.375,2.36\n\tc7.045,0,12.756-5.711,12.756-12.756C283.753,269.002,282.875,266.462,281.394,264.378z M47.388,149.612\n\tc-28.228-28.229-28.229-73.996,0-102.225c28.228-28.229,73.996-28.228,102.225,0.001c28.229,28.229,28.229,73.995,0,102.224\n\tC121.385,177.841,75.617,177.841,47.388,149.612z\"/>\n            </svg>\n        </div>\n        <input class=\"ng-spotlight-input\" type=\"text\" placeholder=\"Spotlight-Suche\" ng-model=\"searchTerm\" ng-change=\"search()\"/>\n\n        <div class=\"ng-spotlight-input-after\" ng-if=\"searchInputInfo && searchInputInfo.length > 0\">&mdash; {{searchInputInfo}}</div>\n        <div class=\"ng-spotlight-results-icon\">\n            <spotlight-result-icon selected-item=\"selectedItem\"></spotlight-result-icon>\n        </div>\n    </div>\n    <div class=\"ng-spotlight-results-panel\" ng-if=\"searchTerm && searchTerm.length > 0\">\n        <div class=\"ng-spotlight-results-list\">\n            <ul>\n                <li class=\"ng-spotlight-results-category\" ng-repeat=\"searchResult in searchResults\" ng-init=\"catIndex=$index\">\n                    <div class=\"ng-spotlight-results-list-header\">{{searchResult.name}}</div>\n                    <ul>\n                        <li class=\"ng-spotlight-results-list-item\"\n                            ng-class=\"{'active': selectedItem.name == resultItem.name}\"\n                            ng-repeat=\"resultItem in searchResult.items\"\n                            ng-click=\"showResultItem($event, resultItem)\">\n                            <spotlight-result-icon type=\"{{resultItem.type || 'default'}}\"></spotlight-result-icon>\n                            {{resultItem.name}}\n                            <span class=\"info\" ng-if=\"resultItem.info\">\n                                &ndash; {{resultItem.info}}\n                            </span>\n                        </li>\n                    </ul>\n                </li>\n            </ul>\n        </div>\n        <div class=\"ng-spotlight-results-detail\">\n            <spotlight-details></spotlight-details>\n        </div>\n    </div>\n</div>");
}]);